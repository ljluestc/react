/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**@flow*/importtype{ReactContext}from'shared/ReactTypes';import{REACT_SERVER_CONTEXT_DEFAULT_VALUE_NOT_LOADED}from'shared/ReactSymbols';import{isPrimaryRenderer}from'./ReactFizzConfig';letrendererSigil;if(__DEV__){//UsethistodetectmultiplerenderersusingthesamecontextrendererSigil={};}//Usedtostoretheparentpathofallcontextoverridesinasharedlinkedlist.//Formingareversetree.typeContextNode<T>={parent:null|ContextNode<any>,depth:number,//Shorthandtocomputethedepthofthetreeatthisnode.context:ReactContext<T>,parentValue:T,value:T,};//Thestructureofacontextsnapshotisanimplementationofthisfile.//Currently,it'simplementedastrackingthecurrentactivenode.exportopaquetypeContextSnapshot=null|ContextNode<any>;exportconstrootContextSnapshot:ContextSnapshot=null;//Weassumethatthisruntimeownsthe"current"fieldonallReactContextinstances.//Thisglobal(actuallythreadlocal)staterepresentswhatstateallthose"current",//fieldsarecurrentlyin.letcurrentActiveSnapshot:ContextSnapshot=null;functionpopNode(prev:ContextNode<any>):void{if(isPrimaryRenderer){prev.context._currentValue=prev.parentValue;}else{prev.context._currentValue2=prev.parentValue;}}functionpushNode(next:ContextNode<any>):void{if(isPrimaryRenderer){next.context._currentValue=next.value;}else{next.context._currentValue2=next.value;}}functionpopToNearestCommonAncestor(prev:ContextNode<any>,next:ContextNode<any>,):void{if(prev===next){//We'vefoundasharedancestor.Wedon'tneedtopopnorreapplythisoneoranythingabove.}else{popNode(prev);constparentPrev=prev.parent;constparentNext=next.parent;if(parentPrev===null){if(parentNext!==null){thrownewError('Thestacksmustreachtherootatthesametime.ThisisabuginReact.',);}}else{if(parentNext===null){thrownewError('Thestacksmustreachtherootatthesametime.ThisisabuginReact.',);}popToNearestCommonAncestor(parentPrev,parentNext);}//Onthewayback,wepushthenewonesthatweren'tcommon.pushNode(next);}}functionpopAllPrevious(prev:ContextNode<any>):void{popNode(prev);constparentPrev=prev.parent;if(parentPrev!==null){popAllPrevious(parentPrev);}}functionpushAllNext(next:ContextNode<any>):void{constparentNext=next.parent;if(parentNext!==null){pushAllNext(parentNext);}pushNode(next);}functionpopPreviousToCommonLevel(prev:ContextNode<any>,next:ContextNode<any>,):void{popNode(prev);constparentPrev=prev.parent;if(parentPrev===null){thrownewError('Thedepthmustequalatleastatzerobeforereachingtheroot.ThisisabuginReact.',);}if(parentPrev.depth===next.depth){//Wefoundthesamelevel.Nowwejustneedtofindasharedancestor.popToNearestCommonAncestor(parentPrev,next);}else{//Wemuststillbedeeper.popPreviousToCommonLevel(parentPrev,next);}}functionpopNextToCommonLevel(prev:ContextNode<any>,next:ContextNode<any>,):void{constparentNext=next.parent;if(parentNext===null){thrownewError('Thedepthmustequalatleastatzerobeforereachingtheroot.ThisisabuginReact.',);}if(prev.depth===parentNext.depth){//Wefoundthesamelevel.Nowwejustneedtofindasharedancestor.popToNearestCommonAncestor(prev,parentNext);}else{//Wemuststillbedeeper.popNextToCommonLevel(prev,parentNext);}pushNode(next);}//Performcontextswitchingtothenewsnapshot.//Tomakeitcheaptoreadmanycontexts,whilenotsuspending,wemaketheswitcheagerlyby//updatingallthecontext'scurrentvalues.Thatwayreads,alwaysjustreadthecurrentvalue.//Atthecostofupdatingcontextsevenifthey'reneverreadbythissubtree.exportfunctionswitchContext(newSnapshot:ContextSnapshot):void{//Thebasicalgorithmweneedtodoistopopbackanycontextsthatarenolongeronthestack.//Wealsoneedtoupdateanynewcontextsthatarenowonthestackwiththedeepestvalue.//Theeasiestwaytoupdatenewcontextsistojustreapplytheminreverseorderfromthe//perspectiveofthebackpointers.Toavoidallocatingalotwhenswitching,weusethestack//forthat.Thereforethisalgorithmisrecursive.//1)Firstwepopwhicheversnapshottreewasdeepest.Poppingoldcontextsaswego.//2)Thenwefindthenearestcommonancestorfromthere.Poppingoldcontextsaswego.//3)Thenwereapplynewcontextsonthewaybackupthestack.constprev=currentActiveSnapshot;constnext=newSnapshot;if(prev!==next){if(prev===null){//$FlowFixMe[incompatible-call]:Thishastobenon-nullsinceit'snotequaltoprev.pushAllNext(next);}elseif(next===null){popAllPrevious(prev);}elseif(prev.depth===next.depth){popToNearestCommonAncestor(prev,next);}elseif(prev.depth>next.depth){popPreviousToCommonLevel(prev,next);}else{popNextToCommonLevel(prev,next);}currentActiveSnapshot=next;}}exportfunctionpushProvider<T>(context:ReactContext<T>,nextValue:T,):ContextSnapshot{letprevValue;if(isPrimaryRenderer){prevValue=context._currentValue;context._currentValue=nextValue;if(__DEV__){if(context._currentRenderer!==undefined&&context._currentRenderer!==null&&context._currentRenderer!==rendererSigil){console.error('Detectedmultiplerenderersconcurrentlyrenderingthe'+'samecontextprovider.Thisiscurrentlyunsupported.',);}context._currentRenderer=rendererSigil;}}else{prevValue=context._currentValue2;context._currentValue2=nextValue;if(__DEV__){if(context._currentRenderer2!==undefined&&context._currentRenderer2!==null&&context._currentRenderer2!==rendererSigil){console.error('Detectedmultiplerenderersconcurrentlyrenderingthe'+'samecontextprovider.Thisiscurrentlyunsupported.',);}context._currentRenderer2=rendererSigil;}}constprevNode=currentActiveSnapshot;constnewNode:ContextNode<T>={parent:prevNode,depth:prevNode===null?0:prevNode.depth+1,context:context,parentValue:prevValue,value:nextValue,};currentActiveSnapshot=newNode;returnnewNode;}exportfunctionpopProvider<T>(context:ReactContext<T>):ContextSnapshot{constprevSnapshot=currentActiveSnapshot;if(prevSnapshot===null){thrownewError('TriedtopopaContextattherootoftheapp.ThisisabuginReact.',);}if(__DEV__){if(prevSnapshot.context!==context){console.error('Theparentcontextisnottheexpectedcontext.ThisisprobablyabuginReact.',);}}if(isPrimaryRenderer){constvalue=prevSnapshot.parentValue;if(value===REACT_SERVER_CONTEXT_DEFAULT_VALUE_NOT_LOADED){prevSnapshot.context._currentValue=prevSnapshot.context._defaultValue;}else{prevSnapshot.context._currentValue=value;}if(__DEV__){if(context._currentRenderer!==undefined&&context._currentRenderer!==null&&context._currentRenderer!==rendererSigil){console.error('Detectedmultiplerenderersconcurrentlyrenderingthe'+'samecontextprovider.Thisiscurrentlyunsupported.',);}context._currentRenderer=rendererSigil;}}else{constvalue=prevSnapshot.parentValue;if(value===REACT_SERVER_CONTEXT_DEFAULT_VALUE_NOT_LOADED){prevSnapshot.context._currentValue2=prevSnapshot.context._defaultValue;}else{prevSnapshot.context._currentValue2=value;}if(__DEV__){if(context._currentRenderer2!==undefined&&context._currentRenderer2!==null&&context._currentRenderer2!==rendererSigil){console.error('Detectedmultiplerenderersconcurrentlyrenderingthe'+'samecontextprovider.Thisiscurrentlyunsupported.',);}context._currentRenderer2=rendererSigil;}}return(currentActiveSnapshot=prevSnapshot.parent);}exportfunctiongetActiveContext():ContextSnapshot{returncurrentActiveSnapshot;}exportfunctionreadContext<T>(context:ReactContext<T>):T{constvalue=isPrimaryRenderer?context._currentValue:context._currentValue2;returnvalue;}
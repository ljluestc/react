/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**@flow*/importtype{Thenable,ReactCustomFormAction}from'shared/ReactTypes';import{REACT_ELEMENT_TYPE,REACT_LAZY_TYPE,REACT_PROVIDER_TYPE,getIteratorFn,}from'shared/ReactSymbols';import{describeObjectForErrorMessage,isSimpleObject,objectName,}from'shared/ReactSerializationErrors';importisArrayfrom'shared/isArray';importtype{FulfilledThenable,RejectedThenable,}from'../../shared/ReactTypes';import{usedWithSSR}from'./ReactFlightClientConfig';typeReactJSONValue=|string|boolean|number|null|$ReadOnlyArray<ReactJSONValue>|ReactServerObject;exportopaquetypeServerReference<T>=T;exporttypeCallServerCallback=<A,T>(id:any,args:A)=>Promise<T>;exporttypeServerReferenceId=any;exportconstknownServerReferences:WeakMap<Function,{id:ServerReferenceId,bound:null|Thenable<Array<any>>},>=newWeakMap();//SerializablevaluesexporttypeReactServerValue=//Referencesarepassedbytheirvalue|ServerReference<any>//Therestarepassedasis.Sub-typescanbepassedinbutlosetheir//subtype,sothereceivercanonlyacceptonceofthese.|string|boolean|number|symbol|null|void|bigint|Iterable<ReactServerValue>|Array<ReactServerValue>|Map<ReactServerValue,ReactServerValue>|Set<ReactServerValue>|Date|ReactServerObject|Promise<ReactServerValue>;//Thenable<ReactServerValue>typeReactServerObject={+[key:string]:ReactServerValue};//functionserializeByValueID(id:number):string{//return'$'+id.toString(16);//}functionserializePromiseID(id:number):string{return'$@'+id.toString(16);}functionserializeServerReferenceID(id:number):string{return'$F'+id.toString(16);}functionserializeSymbolReference(name:string):string{return'$S'+name;}functionserializeFormDataReference(id:number):string{//WhyK?Fis"Function".Dis"Date".Whatelse?return'$K'+id.toString(16);}functionserializeNumber(number:number):string|number{if(Number.isFinite(number)){if(number===0&&1/number===-Infinity){return'$-0';}else{returnnumber;}}else{if(number===Infinity){return'$Infinity';}elseif(number===-Infinity){return'$-Infinity';}else{return'$NaN';}}}functionserializeUndefined():string{return'$undefined';}functionserializeDateFromDateJSON(dateJSON:string):string{//JSON.stringifyautomaticallycallsDate.prototype.toJSONwhichcallstoISOString.//Weneedonlytackona$Dprefix.return'$D'+dateJSON;}functionserializeBigInt(n:bigint):string{return'$n'+n.toString(10);}functionserializeMapID(id:number):string{return'$Q'+id.toString(16);}functionserializeSetID(id:number):string{return'$W'+id.toString(16);}functionescapeStringValue(value:string):string{if(value[0]==='$'){//Weneedtoescape$prefixedstringssinceweusethosetoencode//referencestoIDsandasspecialsymbolvalues.return'$'+value;}else{returnvalue;}}exportfunctionprocessReply(root:ReactServerValue,formFieldPrefix:string,resolve:(string|FormData)=>void,reject:(error:mixed)=>void,):void{letnextPartId=1;letpendingParts=0;letformData:null|FormData=null;functionresolveToJSON(this:|{+[key:string|number]:ReactServerValue}|$ReadOnlyArray<ReactServerValue>,key:string,value:ReactServerValue,):ReactJSONValue{constparent=this;//Makesurethat`parent[key]`wasn'tJSONifiedbefore`value`waspassedtousif(__DEV__){//$FlowFixMe[incompatible-use]constoriginalValue=parent[key];if(typeoforiginalValue==='object'&&originalValue!==value&&!(originalValueinstanceofDate)){if(objectName(originalValue)!=='Object'){console.error('OnlyplainobjectscanbepassedtoServerFunctionsfromtheClient.'+'%sobjectsarenotsupported.%s',objectName(originalValue),describeObjectForErrorMessage(parent,key),);}else{console.error('OnlyplainobjectscanbepassedtoServerFunctionsfromtheClient.'+'ObjectswithtoJSONmethodsarenotsupported.Convertitmanually'+'toasimplevaluebeforepassingittoprops.%s',describeObjectForErrorMessage(parent,key),);}}}if(value===null){returnnull;}if(typeofvalue==='object'){//$FlowFixMe[method-unbinding]if(typeofvalue.then==='function'){//Weassumethatanyobjectwitha.thenpropertyisa"Thenable"type,//oraPromisetype.EitherofwhichcanberepresentedbyaPromise.if(formData===null){//UpgradetouseFormDatatoallowustostreamthisvalue.formData=newFormData();}pendingParts++;constpromiseId=nextPartId++;constthenable:Thenable<any>=(value:any);thenable.then(partValue=>{constpartJSON=JSON.stringify(partValue,resolveToJSON);//$FlowFixMe[incompatible-type]Weknowit'snotnullbecauseweassigneditabove.constdata:FormData=formData;//eslint-disable-next-linereact-internal/safe-string-coerciondata.append(formFieldPrefix+promiseId,partJSON);pendingParts--;if(pendingParts===0){resolve(data);}},reason=>{//Inthefuturewecouldconsiderserializingthisasanerror//thatthrowsontheserverinstead.reject(reason);},);returnserializePromiseID(promiseId);}//TODO:ShouldwetheObject.prototype.toString.call()totestforcross-realmobjects?if(valueinstanceofFormData){if(formData===null){//UpgradetouseFormDatatoallowustouserichobjectsasitsvalues.formData=newFormData();}constdata:FormData=formData;constrefId=nextPartId++;//Copyalltheformfieldswithaprefixforthisreference.//Thesemustcomefirstintheformorderbecauseweassumethatallthe//fieldsareavailablebeforethisisreferenced.constprefix=formFieldPrefix+refId+'_';//$FlowFixMe[prop-missing]:FormDatahasforEach.value.forEach((originalValue:string|File,originalKey:string)=>{data.append(prefix+originalKey,originalValue);});returnserializeFormDataReference(refId);}if(valueinstanceofMap){constpartJSON=JSON.stringify(Array.from(value),resolveToJSON);if(formData===null){formData=newFormData();}constmapId=nextPartId++;formData.append(formFieldPrefix+mapId,partJSON);returnserializeMapID(mapId);}if(valueinstanceofSet){constpartJSON=JSON.stringify(Array.from(value),resolveToJSON);if(formData===null){formData=newFormData();}constsetId=nextPartId++;formData.append(formFieldPrefix+setId,partJSON);returnserializeSetID(setId);}if(!isArray(value)){constiteratorFn=getIteratorFn(value);if(iteratorFn){returnArray.from((value:any));}}if(__DEV__){if(value!==null&&!isArray(value)){//Verifythatthisisasimpleplainobject.if((value:any).$$typeof===REACT_ELEMENT_TYPE){console.error('ReactElementcannotbepassedtoServerFunctionsfromtheClient.%s',describeObjectForErrorMessage(parent,key),);}elseif((value:any).$$typeof===REACT_LAZY_TYPE){console.error('ReactLazycannotbepassedtoServerFunctionsfromtheClient.%s',describeObjectForErrorMessage(parent,key),);}elseif((value:any).$$typeof===REACT_PROVIDER_TYPE){console.error('ReactContextProviderscannotbepassedtoServerFunctionsfromtheClient.%s',describeObjectForErrorMessage(parent,key),);}elseif(objectName(value)!=='Object'){console.error('OnlyplainobjectscanbepassedtoClientComponentsfromServerComponents.'+'%sobjectsarenotsupported.%s',objectName(value),describeObjectForErrorMessage(parent,key),);}elseif(!isSimpleObject(value)){console.error('OnlyplainobjectscanbepassedtoClientComponentsfromServerComponents.'+'Classesorotherobjectswithmethodsarenotsupported.%s',describeObjectForErrorMessage(parent,key),);}elseif(Object.getOwnPropertySymbols){constsymbols=Object.getOwnPropertySymbols(value);if(symbols.length>0){console.error('OnlyplainobjectscanbepassedtoClientComponentsfromServerComponents.'+'Objectswithsymbolpropertieslike%sarenotsupported.%s',symbols[0].description,describeObjectForErrorMessage(parent,key),);}}}}//$FlowFixMe[incompatible-return]returnvalue;}if(typeofvalue==='string'){//TODO:Maybetooclever.IfwesupportURLthere'snosimilartrick.if(value[value.length-1]==='Z'){//PossiblyaDate,whosetoJSONautomaticallycallstoISOString//$FlowFixMe[incompatible-use]constoriginalValue=parent[key];if(originalValueinstanceofDate){returnserializeDateFromDateJSON(value);}}returnescapeStringValue(value);}if(typeofvalue==='boolean'){returnvalue;}if(typeofvalue==='number'){returnserializeNumber(value);}if(typeofvalue==='undefined'){returnserializeUndefined();}if(typeofvalue==='function'){constmetaData=knownServerReferences.get(value);if(metaData!==undefined){constmetaDataJSON=JSON.stringify(metaData,resolveToJSON);if(formData===null){//UpgradetouseFormDatatoallowustostreamthisvalue.formData=newFormData();}//Thereferencetothisfunctioncamefromthesameclientsowecanpassitback.constrefId=nextPartId++;//eslint-disable-next-linereact-internal/safe-string-coercionformData.set(formFieldPrefix+refId,metaDataJSON);returnserializeServerReferenceID(refId);}thrownewError('ClientFunctionscannotbepasseddirectlytoServerFunctions.'+'OnlyFunctionspassedfromtheServercanbepassedbackagain.',);}if(typeofvalue==='symbol'){//$FlowFixMe[incompatible-type]`description`mightbeundefinedconstname:string=value.description;if(Symbol.for(name)!==value){thrownewError('OnlyglobalsymbolsreceivedfromSymbol.for(...)canbepassedtoServerFunctions.'+`ThesymbolSymbol.for(${//$FlowFixMe[incompatible-type]`description`mightbeundefinedvalue.description})cannotbefoundamongglobalsymbols.`,);}returnserializeSymbolReference(name);}if(typeofvalue==='bigint'){returnserializeBigInt(value);}thrownewError(`Type${typeofvalue}isnotsupportedasanargumenttoaServerFunction.`,);}//$FlowFixMe[incompatible-type]it'snotgoingtobeundefinedbecausewe'llencodeit.constjson:string=JSON.stringify(root,resolveToJSON);if(formData===null){//Ifit'sasimpledatastructure,wejustuseplainJSON.resolve(json);}else{//Otherwise,weuseFormDatatoletusstreamintheresult.formData.set(formFieldPrefix+'0',json);if(pendingParts===0){//$FlowFixMe[incompatible-call]thishasalreadybeenrefined.resolve(formData);}}}constboundCache:WeakMap<{id:ServerReferenceId,bound:null|Thenable<Array<any>>},Thenable<FormData>,>=newWeakMap();functionencodeFormData(reference:any):Thenable<FormData>{letresolve,reject;//Weneedtohaveahandleonthethenablesothatwecansynchronouslyset//itsstatusfromprocessReply,whenitcancompletesynchronously.constthenable:Thenable<FormData>=newPromise((res,rej)=>{resolve=res;reject=rej;});processReply(reference,'',(body:string|FormData)=>{if(typeofbody==='string'){constdata=newFormData();data.append('0',body);body=data;}constfulfilled:FulfilledThenable<FormData>=(thenable:any);fulfilled.status='fulfilled';fulfilled.value=body;resolve(body);},e=>{constrejected:RejectedThenable<FormData>=(thenable:any);rejected.status='rejected';rejected.reason=e;reject(e);},);returnthenable;}exportfunctionencodeFormAction(this:any=>Promise<any>,identifierPrefix:string,):ReactCustomFormAction{constreference=knownServerReferences.get(this);if(!reference){thrownewError('TriedtoencodeaServerActionfromadifferentinstancethantheencoderisfrom.'+'ThisisabuginReact.',);}letdata:null|FormData=null;letname;constboundPromise=reference.bound;if(boundPromise!==null){letthenable=boundCache.get(reference);if(!thenable){thenable=encodeFormData(reference);boundCache.set(reference,thenable);}if(thenable.status==='rejected'){throwthenable.reason;}elseif(thenable.status!=='fulfilled'){throwthenable;}constencodedFormData=thenable.value;//Thisishackybutweneedtheidentifierprefixtobeaddedto//allfieldsbutthesuspensecachewouldbreaksincewemightget//anewidentifiereachtime.Sowejustappenditattheendinstead.constprefixedData=newFormData();//$FlowFixMe[prop-missing]encodedFormData.forEach((value:string|File,key:string)=>{prefixedData.append('$ACTION_'+identifierPrefix+':'+key,value);});data=prefixedData;//Weencodethenameoftheprefixcontainingthedata.name='$ACTION_REF_'+identifierPrefix;}else{//ThisisthesimplecasesowecanjustencodetheID.name='$ACTION_ID_'+reference.id;}return{name:name,method:'POST',encType:'multipart/form-data',data:data,};}exportfunctioncreateServerReference<A:Iterable<any>,T>(id:ServerReferenceId,callServer:CallServerCallback,):(...A)=>Promise<T>{constproxy=function():Promise<T>{//$FlowFixMe[method-unbinding]constargs=Array.prototype.slice.call(arguments);returncallServer(id,args);};//ExposeencoderforusebySSR.if(usedWithSSR){//Onlyexposethisinbuildsthatwouldactuallyuseit.Notneededontheclient.(proxy:any).$$FORM_ACTION=encodeFormAction;}knownServerReferences.set(proxy,{id:id,bound:null});returnproxy;}
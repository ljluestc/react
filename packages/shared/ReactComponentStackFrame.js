/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**@flow*/importtype{Source}from'shared/ReactElementType';importtype{LazyComponent}from'react/src/ReactLazy';import{enableComponentStackLocations}from'shared/ReactFeatureFlags';import{REACT_SUSPENSE_TYPE,REACT_SUSPENSE_LIST_TYPE,REACT_FORWARD_REF_TYPE,REACT_MEMO_TYPE,REACT_LAZY_TYPE,}from'shared/ReactSymbols';import{disableLogs,reenableLogs}from'shared/ConsolePatchingDev';importReactSharedInternalsfrom'shared/ReactSharedInternals';const{ReactCurrentDispatcher}=ReactSharedInternals;letprefix;exportfunctiondescribeBuiltInComponentFrame(name:string,source:void|null|Source,ownerFn:void|null|Function,):string{if(enableComponentStackLocations){if(prefix===undefined){//ExtracttheVMspecificprefixusedbyeachline.try{throwError();}catch(x){constmatch=x.stack.trim().match(/\n(*(at)?)/);prefix=(match&&match[1])||'';}}//Weusetheprefixtoensureourstackslineupwithnativestackframes.return'\n'+prefix+name;}else{letownerName=null;if(__DEV__&&ownerFn){ownerName=ownerFn.displayName||ownerFn.name||null;}returndescribeComponentFrame(name,source,ownerName);}}letreentry=false;letcomponentFrameCache;if(__DEV__){constPossiblyWeakMap=typeofWeakMap==='function'?WeakMap:Map;componentFrameCache=newPossiblyWeakMap<Function,string>();}exportfunctiondescribeNativeComponentFrame(fn:Function,construct:boolean,):string{//Ifsomethingaskedforastackinsideafakerender,itshouldgetignored.if(!fn||reentry){return'';}if(__DEV__){constframe=componentFrameCache.get(fn);if(frame!==undefined){returnframe;}}letcontrol;reentry=true;constpreviousPrepareStackTrace=Error.prepareStackTrace;//$FlowFixMe[incompatible-type]Itdoesacceptundefined.Error.prepareStackTrace=undefined;letpreviousDispatcher;if(__DEV__){previousDispatcher=ReactCurrentDispatcher.current;//SetthedispatcherinDEVbecausethismightbecallintherenderfunction//forwarnings.ReactCurrentDispatcher.current=null;disableLogs();}try{//Thisshouldthrow.if(construct){//Somethingshouldbesettingthepropsintheconstructor.constFake=function(){throwError();};//$FlowFixMe[prop-missing]Object.defineProperty(Fake.prototype,'props',{set:function(){//Weuseathrowingsetterinsteadoffrozenornon-writableprops//becausethatwon'tthrowinanon-strictmodefunction.throwError();},});if(typeofReflect==='object'&&Reflect.construct){//Weconstructadifferentcontrolforthiscasetoincludeanyextra//framesaddedbytheconstructcall.try{Reflect.construct(Fake,[]);}catch(x){control=x;}Reflect.construct(fn,[],Fake);}else{try{Fake.call();}catch(x){control=x;}//$FlowFixMe[prop-missing]foundwhenupgradingFlowfn.call(Fake.prototype);}}else{try{throwError();}catch(x){control=x;}//TODO(luna):Thiswillcurrentlyonlythrowifthefunctioncomponent//triestoaccessReact/ReactDOM/props.Weshouldprobablymakethisthrow//insimplecomponentstooconstmaybePromise=fn();//Ifthefunctioncomponentreturnsapromise,it'slikelyanasync//component,whichwedon'tyetsupport.Attachanoopcatchhandlerto//silencetheerror.//TODO:Implementcomponentstacksforasyncclientcomponents?if(maybePromise&&typeofmaybePromise.catch==='function'){maybePromise.catch(()=>{});}}}catch(sample){//Thisisinlinedmanuallybecauseclosuredoesn'tdoitforus.if(sample&&control&&typeofsample.stack==='string'){//Thisextractsthefirstframefromthesamplethatisn'talsointhecontrol.//Skippingoneframethatweassumeistheframethatcallsthetwo.constsampleLines=sample.stack.split('\n');constcontrolLines=control.stack.split('\n');lets=sampleLines.length-1;letc=controlLines.length-1;while(s>=1&&c>=0&&sampleLines[s]!==controlLines[c]){//Weexpectatleastonestackframetobeshared.//Typicallythiswillbetherootmostone.However,stackframesmaybe//cutoffduetomaximumstacklimits.Inthiscase,onemaybecutoff//earlierthantheother.Weassumethatthesampleislongerorthesame//andthereforcutoffearlier.Soweshouldfindtherootmostframein//thesamplesomewhereinthecontrol.c--;}for(;s>=1&&c>=0;s--,c--){//Nextwefindthefirstonethatisn'tthesamewhichshouldbethe//framethatcalledoursamplefunctionandthecontrol.if(sampleLines[s]!==controlLines[c]){//InV8,thefirstlineisdescribingthemessagebutotherVMsdon't.//Ifwe'reabouttoreturnthefirstline,andthecontrolisalsoonthesame//line,that'saprettygoodindicatorthatoursamplethrewatsamelineas//thecontrol.I.e.beforeweenteredthesampleframe.Soweignorethisresult.//Thiscanhappenifyoupassedaclasstofunctioncomponent,ornon-function.if(s!==1||c!==1){do{s--;c--;//Wemaystillhavesimilarintermediateframesfromtheconstructcall.//Thenextonethatisn'tthesameshouldbeourmatchthough.if(c<0||sampleLines[s]!==controlLines[c]){//V8addsa"new"prefixfornativeclasses.Let'sremoveittomakeitprettier.letframe='\n'+sampleLines[s].replace('atnew','at');//Ifourcomponentframeislabeled"<anonymous>"//butwehaveauser-provided"displayName"//spliceitintomakethestackmorereadable.if(fn.displayName&&frame.includes('<anonymous>')){me=frame.replace('<anonymous>',fn.displayName);}if(__DEV__){ifpeoffn==='function'){componentFrameCache.set(fn,frame);}}//turnthelinewefound.returnframe;}}while(s>=1&&c>=0);}break;}}}}finally{reentry=false;if(__DEV__){ReactCurrentDispatcher.current=previousDispatcher;reenableLogs();}Error.prepareStackTrace=previousPrepareStackTrace;}//Fallbacktojustusingthenameifwecouldn'tmakeitthrow.constname=fn?fn.displayName||fn.name:'';constsyntheticFrame=name?describeBuiltInComponentFrame(name):'';if(__DEV__){if(typeoffn==='function'){componentFrameCache.set(fn,syntheticFrame);}}returnsyntheticFrame;}constBEFORE_SLASH_RE=/^(.*)[\\\/]/;functiondescribeComponentFrame(name:null|string,source:void|null|Source,ownerName:null|string,){letsourceInfo='';if(__DEV__&&source){constpath=source.fileName;letfileName=path.replace(BEFORE_SLASH_RE,'');//InDEV,includecodeforacommonspecialcase://prefer"folder/index.js"insteadofjust"index.js".if(/^index\./.test(fileName)){constmatch=path.match(BEFORE_SLASH_RE);if(match){constpathBeforeSlash=match[1];if(pathBeforeSlash){constfolderName=pathBeforeSlash.replace(BEFORE_SLASH_RE,'');fileName=folderName+'/'+fileName;}}}sourceInfo='(at'+fileName+':'+source.lineNumber+')';}elseif(ownerName){sourceInfo='(createdby'+ownerName+')';}return'\nin'+(name||'Unknown')+sourceInfo;}exportfunctiondescribeClassComponentFrame(ctor:Function,source:void|null|Source,ownerFn:void|null|Function,):string{if(enableComponentStackLocations){returndescribeNativeComponentFrame(ctor,true);}else{returndescribeFunctionComponentFrame(ctor,source,ownerFn);}}exportfunctiondescribeFunctionComponentFrame(fn:Function,source:void|null|Source,ownerFn:void|null|Function,):string{if(enableComponentStackLocations){returndescribeNativeComponentFrame(fn,false);}else{if(!fn){return'';}constname=fn.displayName||fn.name||null;letownerName=null;if(__DEV__&&ownerFn){ownerName=ownerFn.displayName||ownerFn.name||null;}returndescribeComponentFrame(name,source,ownerName);}}functionshouldConstruct(Component:Function){constprototype=Component.prototype;return!!(prototype&&prototype.isReactComponent);}exportfunctiondescribeUnknownElementTypeFrameInDEV(type:any,source:void|null|Source,ownerFn:void|null|Function,):string{if(!__DEV__){return'';}if(type==null){return'';}if(typeoftype==='function'){if(enableComponentStackLocations){returndescribeNativeComponentFrame(type,shouldConstruct(type));}else{returndescribeFunctionComponentFrame(type,source,ownerFn);}}if(typeoftype==='string'){returndescribeBuiltInComponentFrame(type,source,ownerFn);}switch(type){caseREACT_SUSPENSE_TYPE:returndescribeBuiltInComponentFrame('Suspense',source,ownerFn);caseREACT_SUSPENSE_LIST_TYPE:returndescribeBuiltInComponentFrame('SuspenseList',source,ownerFn);}if(typeoftype==='object'){switch(type.$$typeof){caseREACT_FORWARD_REF_TYPE:returndescribeFunctionComponentFrame(type.render,source,ownerFn);caseREACT_MEMO_TYPE://Memomaycontainanycomponenttypesowerecursivelyresolveit.returndescribeUnknownElementTypeFrameInDEV(type.type,source,ownerFn);caseREACT_LAZY_TYPE:{constlazyComponent:LazyComponent<any,any>=(type:any);constpayload=lazyComponent._payload;constinit=lazyComponent._init;try{//Lazymaycontainanycomponenttypesowerecursivelyresolveit.returndescribeUnknownElementTypeFrameInDEV(init(payload),source,ownerFn,);}catch(x){}}}}return'';}
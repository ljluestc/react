/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**@flow*/letfakeNode:Element=(null:any);if(__DEV__){if(typeofwindow!=='undefined'&&typeofwindow.dispatchEvent==='function'&&typeofdocument!=='undefined'&&//$FlowFixMe[method-unbinding]typeofdocument.createEvent==='function'){fakeNode=document.createElement('react');}}exportdefaultfunctioninvokeGuardedCallbackImpl<Args:Array<mixed>,Context>(this:{onError:(error:mixed)=>void},name:string|null,func:(...Args)=>mixed,context:Context,):void{if(__DEV__){//InDEVmode,weuseaspecialversion//thatplaysmorenicelywiththebrowser'sDevTools.Theideaistopreserve//"Pauseonexceptions"behavior.BecauseReactwrapsalluser-provided//functionsininvokeGuardedCallback,andtheproductionversionof//invokeGuardedCallbackusesatry-catch,alluserexceptionsaretreated//likecaughtexceptions,andtheDevToolswon'tpauseunlessthedeveloper//takestheextrastepofenablingpauseoncaughtexceptions.Thisis//unintuitive,though,becauseeventhoughReacthascaughttheerror,from//thedeveloper'sperspective,theerrorisuncaught.////Topreservetheexpected"Pauseonexceptions"behavior,wedon'tusea//try-catchinDEV.Instead,wesynchronouslydispatchafakeeventtoafake//DOMnode,andcalltheuser-providedcallbackfrominsideaneventhandler//forthatfakeevent.Ifthecallbackthrows,theerroris"captured"using//eventloopcontext,itdoesnotinterruptthenormalprogramflow.//Effectively,thisgivesustry-catchbehaviorwithoutactuallyusing//try-catch.Neat!//fakeNodesignifiesweareinanenvironmentwithadocumentandwindowobjectif(fakeNode){constevt=document.createEvent('Event');letdidCall=false;//Keepstrackofwhethertheuser-providedcallbackthrewanerror.We//setthistotrueatthebeginning,thensetittofalserightafter//callingthefunction.Ifthefunctionerrors,`didError`willneverbe//settofalse.Thisstrategyworksevenifthebrowserisflakyand//failstocallourglobalerrorhandler,becauseitdoesn'trelyon//theerroreventatall.letdidError=true;//Keepstrackofthevalueofwindow.eventsothatwecanresetit//duringthecallbacktoletusercodeaccesswindow.eventinthe//browsersthatsupportit.constwindowEvent=window.event;//Keepstrackofthedescriptorofwindow.eventtorestoreitafterevent//dispatching:https://github.com/facebook/react/issues/13688constwindowEventDescriptor=Object.getOwnPropertyDescriptor(window,'event',);constrestoreAfterDispatch=()=>{//Weimmediatelyremovethecallbackfromeventlistenerssothat//nested`invokeGuardedCallback`callsdonotclash.Otherwise,a//nestedcallwouldtriggerthefakeeventhandlersofanycallhigher//inthestack.fakeNode.removeEventListener(evtType,callCallback,false);//Wecheckforwindow.hasOwnProperty('event')topreventthe//window.eventassignmentinbothIE<=10astheythrowanerror//"Membernotfound"instrictmode,andinFirefoxwhichdoesnot//supportwindow.event.if(typeofwindow.event!=='undefined'&&window.hasOwnProperty('event')){window.event=windowEvent;}};//Createaneventhandlerforourfakeevent.Wewillsynchronously//dispatchourfakeeventusing`dispatchEvent`.Insidethehandler,we//calltheuser-providedcallback.//$FlowFixMe[method-unbinding]constfuncArgs=Array.prototype.slice.call(arguments,3);constcallCallback=()=>{didCall=true;restoreAfterDispatch();//$FlowFixMe[incompatible-call]Flowdoesn'tunderstandtheargumentssplicing.func.apply(context,funcArgs);didError=false;};//Createaglobalerroreventhandler.Weusethistocapturethevalue//thatwasthrown.It'spossiblethatthiserrorhandlerwillfiremore//thanonce;forexample,ifnon-Reactcodealsocalls`dispatchEvent`//andahandlerforthateventthrows.Weshouldberesilienttomostof//thosecases.Evenifourerroreventhandlerfiresmorethanonce,the//lasterroreventisalwaysused.Ifthecallbackactuallydoeserror,//weknowthatthelasterroreventisthecorrectone,becauseit'snot//possibleforanythingelsetohavehappenedinbetweenourcallback//erroringandthecodethatfollowsthe`dispatchEvent`callbelow.If//thecallbackdoesn'terror,buttheerroreventwasfired,weknowto//ignoreitbecause`didError`willbefalse,asdescribedabove.leterror;//Usethistotrackwhethertheerroreventisevercalled.letdidSetError=false;letisCrossOriginError=false;consthandleWindowError=(event:ErrorEvent)=>{error=event.error;didSetError=true;if(error===null&&event.colno===0&&event.lineno===0){isCrossOriginError=true;}if(event.defaultPrevented){//Someothererrorhandlerhaspreventeddefault.//Browserssilencetheerrorreportifthishappens.//We'llrememberthistolaterdecidewhethertologitornot.if(error!=null&&typeoferror==='object'){try{error._suppressLogging=true;}catch(inner){//Ignore.}}}};//Createafakeeventtype.constevtType=`react-${name?name:'invokeguardedcallback'}`;//Attachoureventhandlerswindow.addEventListener('error',handleWindowError);fakeNode.addEventListener(evtType,callCallback,false);//Synchronouslydispatchourfakeevent.Iftheuser-providedfunction//errors,itwilltriggerourglobalerrorhandler.evt.initEvent(evtType,false,false);fakeNode.dispatchEvent(evt);if(windowEventDescriptor){Object.defineProperty(window,'event',windowEventDescriptor);}if(didCall&&didError){if(!didSetError){//Thecallbackerrored,buttheerroreventneverfired.//eslint-disable-next-linereact-internal/prod-error-codeserror=newError('Anerrorwasthrowninsideoneofyourcomponents,butReact'+"doesn'tknowwhatitwas.Thisislikelyduetobrowser"+'flakiness.Reactdoesitsbesttopreservethe"Pauseon'+'exceptions"behavioroftheDevTools,whichrequiressome'+"DEV-modeonlytricks.It'spossiblethatthesedon'tworkin"+'yourbrowser.Trytriggeringtheerrorinproductionmode,'+'orswitchingtoamodernbrowser.Ifyoususpectthatthisis'+'actuallyanissuewithReact,pleasefileanissue.',);}elseif(isCrossOriginError){//eslint-disable-next-linereact-internal/prod-error-codeserror=newError("Across-originerrorwasthrown.Reactdoesn'thaveaccessto"+'theactualerrorobjectindevelopment.'+'Seehttps://reactjs.org/link/crossorigin-errorformoreinformation.',);}this.onError(error);}//Removeoureventlistenerswindow.removeEventListener('error',handleWindowError);if(didCall){return;}else{//Somethingwentreallywrong,andoureventwasnotdispatched.//https://github.com/facebook/react/issues/16734//https://github.com/facebook/react/issues/16585//Fallbacktotheproductionimplementation.restoreAfterDispatch();//wefallthroughandcalltheprodversioninstead}}//Weonlygethereifweareinanenvironmentthateitherdoesnotsupportthebrowser//variantorwehadtroublegettingthebrowsertoemittheerror.//$FlowFixMe[method-unbinding]constfuncArgs=Array.prototype.slice.call(arguments,3);try{//$FlowFixMe[incompatible-call]Flowdoesn'tunderstandtheargumentssplicing.func.apply(context,funcArgs);}catch(error){this.onError(error);}}else{//$FlowFixMe[method-unbinding]constfuncArgs=Array.prototype.slice.call(arguments,3);try{//$FlowFixMe[incompatible-call]Flowdoesn'tunderstandtheargumentssplicing.func.apply(context,funcArgs);}catch(error){this.onError(error);}}}
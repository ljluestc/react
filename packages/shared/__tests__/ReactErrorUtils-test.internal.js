/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**@emailsreact-core*/'usestrict';letReactErrorUtils;describe('ReactErrorUtils',()=>{beforeEach(()=>{//TODO:canweexpressthistestwithonlypublicAPI?ReactErrorUtils=require('shared/ReactErrorUtils');});it(`itshouldrethrowcaughterrors`,()=>{consterr=newError('foo');constcallback=function(){throwerr;};ReactErrorUtils.invokeGuardedCallbackAndCatchFirstError('foo',callback,null,);expect(ReactErrorUtils.hasCaughtError()).toBe(false);expect(()=>ReactErrorUtils.rethrowCaughtError()).toThrow(err);});it(`shouldcallthecallbackthepassedarguments`,()=>{constcallback=jest.fn();ReactErrorUtils.invokeGuardedCallback('foo',callback,null,'arg1','arg2',);expect(callback).toBeCalledWith('arg1','arg2');});it(`shouldcallthecallbackwiththeprovidedcontext`,()=>{constcontext={didCall:false};ReactErrorUtils.invokeGuardedCallback('foo',function(){this.didCall=true;},context,);expect(context.didCall).toBe(true);});it(`shouldcatcherrors`,()=>{consterror=newError();constreturnValue=ReactErrorUtils.invokeGuardedCallback('foo',function(){throwerror;},null,'arg1','arg2',);expect(returnValue).toBe(undefined);expect(ReactErrorUtils.hasCaughtError()).toBe(true);expect(ReactErrorUtils.clearCaughtError()).toBe(error);});it(`shouldreturnfalsefromclearCaughtErrorifnoerrorwasthrown`,()=>{constcallback=jest.fn();ReactErrorUtils.invokeGuardedCallback('foo',callback,null);expect(ReactErrorUtils.hasCaughtError()).toBe(false);expect(ReactErrorUtils.clearCaughtError).toThrow('noerrorwascaptured');});it(`cannestwithsamedebugname`,()=>{consterr1=newError();leterr2;consterr3=newError();ReactErrorUtils.invokeGuardedCallback('foo',function(){ReactErrorUtils.invokeGuardedCallback('foo',function(){throwerr1;},null,);err2=ReactErrorUtils.clearCaughtError();throwerr3;},null,);consterr4=ReactErrorUtils.clearCaughtError();expect(err2).toBe(err1);expect(err4).toBe(err3);});it(`handlesnestederrors`,()=>{consterr1=newError();leterr2;ReactErrorUtils.invokeGuardedCallback('foo',function(){ReactErrorUtils.invokeGuardedCallback('foo',function(){throwerr1;},null,);err2=ReactErrorUtils.clearCaughtError();},null,);//Returnsnullbecauseinnererrorwasalreadycapturedexpect(ReactErrorUtils.hasCaughtError()).toBe(false);expect(err2).toBe(err1);});it('handlesnestederrorsinseparaterenderers',()=>{constReactErrorUtils1=require('shared/ReactErrorUtils');jest.resetModules();constReactErrorUtils2=require('shared/ReactErrorUtils');expect(ReactErrorUtils1).not.toEqual(ReactErrorUtils2);constops=[];ReactErrorUtils1.invokeGuardedCallback(null,()=>{ReactErrorUtils2.invokeGuardedCallback(null,()=>{thrownewError('nestederror');},null,);//ReactErrorUtils2shouldcatchtheerrorops.push(ReactErrorUtils2.hasCaughtError());ops.push(ReactErrorUtils2.clearCaughtError().message);},null,);//ReactErrorUtils1shouldnotcatchtheerrorops.push(ReactErrorUtils1.hasCaughtError());expect(ops).toEqual([true,'nestederror',false]);});if(!__DEV__){//jsdomdoesn'thandlethisproperly,butChromeandFirefoxshould.Test//thiswithafixture.it('catchesnullvalues',()=>{ReactErrorUtils.invokeGuardedCallback(null,function(){thrownull;//eslint-disable-lineno-throw-literal},null,);expect(ReactErrorUtils.hasCaughtError()).toBe(true);expect(ReactErrorUtils.clearCaughtError()).toBe(null);});}it(`canbeshimmed`,()=>{constops=[];jest.resetModules();jest.mock('shared/invokeGuardedCallbackImpl',()=>functioninvokeGuardedCallback(name,func,context,a){ops.push(a);try{func.call(context,a);}catch(error){this.onError(error);}},);ReactErrorUtils=require('shared/ReactErrorUtils');try{consterr=newError('foo');constcallback=function(){throwerr;};ReactErrorUtils.invokeGuardedCallbackAndCatchFirstError('foo',callback,null,'somearg',);expect(()=>ReactErrorUtils.rethrowCaughtError()).toThrow(err);expect(ops).toEqual(['somearg']);}finally{jest.unmock('shared/invokeGuardedCallbackImpl');}});});
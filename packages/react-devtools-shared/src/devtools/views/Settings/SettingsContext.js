/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**@flow*/importtype{ReactContext}from'shared/ReactTypes';import*asReactfrom'react';import{createContext,useContext,useEffect,useLayoutEffect,useMemo,}from'react';import{LOCAL_STORAGE_BROWSER_THEME,LOCAL_STORAGE_PARSE_HOOK_NAMES_KEY,LOCAL_STORAGE_SHOULD_BREAK_ON_CONSOLE_ERRORS,LOCAL_STORAGE_SHOULD_APPEND_COMPONENT_STACK_KEY,LOCAL_STORAGE_TRACE_UPDATES_ENABLED_KEY,LOCAL_STORAGE_SHOW_INLINE_WARNINGS_AND_ERRORS_KEY,LOCAL_STORAGE_HIDE_CONSOLE_LOGS_IN_STRICT_MODE,}from'react-devtools-shared/src/constants';import{COMFORTABLE_LINE_HEIGHT,COMPACT_LINE_HEIGHT,}from'react-devtools-shared/src/devtools/constants';import{useLocalStorage}from'../hooks';import{BridgeContext}from'../context';import{logEvent}from'react-devtools-shared/src/Logger';importtype{BrowserTheme}from'react-devtools-shared/src/types';exporttypeDisplayDensity='comfortable'|'compact';exporttypeTheme='auto'|'light'|'dark';typeContext={displayDensity:DisplayDensity,setDisplayDensity(value:DisplayDensity):void,//Derivedfromdisplaydensity.//Specifiedasaseparatepropsoitcantriggerare-renderofFixedSizeList.lineHeight:number,appendComponentStack:boolean,setAppendComponentStack:(value:boolean)=>void,breakOnConsoleErrors:boolean,setBreakOnConsoleErrors:(value:boolean)=>void,parseHookNames:boolean,setParseHookNames:(value:boolean)=>void,hideConsoleLogsInStrictMode:boolean,setHideConsoleLogsInStrictMode:(value:boolean)=>void,showInlineWarningsAndErrors:boolean,setShowInlineWarningsAndErrors:(value:boolean)=>void,theme:Theme,setTheme(value:Theme):void,browserTheme:Theme,traceUpdatesEnabled:boolean,setTraceUpdatesEnabled:(value:boolean)=>void,};constSettingsContext:ReactContext<Context>=createContext<Context>(((null:any):Context),);SettingsContext.displayName='SettingsContext';functionuseLocalStorageWithLog<T>(key:string,initialValue:T|(()=>T),):[T,(value:T|(()=>T))=>void]{returnuseLocalStorage<T>(key,initialValue,(v,k)=>{logEvent({event_name:'settings-changed',metadata:{source:'localStoragesetter',key:k,value:v,},});});}typeDocumentElements=Array<HTMLElement>;typeProps={browserTheme:BrowserTheme,children:React$Node,componentsPortalContainer?:Element,profilerPortalContainer?:Element,};functionSettingsContextController({browserTheme,children,componentsPortalContainer,profilerPortalContainer,}:Props):React.Node{constbridge=useContext(BridgeContext);const[displayDensity,setDisplayDensity]=useLocalStorageWithLog<DisplayDensity>('React::DevTools::displayDensity','compact',);const[theme,setTheme]=useLocalStorageWithLog<Theme>(LOCAL_STORAGE_BROWSER_THEME,'auto',);const[appendComponentStack,setAppendComponentStack]=useLocalStorageWithLog<boolean>(LOCAL_STORAGE_SHOULD_APPEND_COMPONENT_STACK_KEY,true,);const[breakOnConsoleErrors,setBreakOnConsoleErrors]=useLocalStorageWithLog<boolean>(LOCAL_STORAGE_SHOULD_BREAK_ON_CONSOLE_ERRORS,false,);const[parseHookNames,setParseHookNames]=useLocalStorageWithLog<boolean>(LOCAL_STORAGE_PARSE_HOOK_NAMES_KEY,false,);const[hideConsoleLogsInStrictMode,setHideConsoleLogsInStrictMode]=useLocalStorageWithLog<boolean>(LOCAL_STORAGE_HIDE_CONSOLE_LOGS_IN_STRICT_MODE,false,);const[showInlineWarningsAndErrors,setShowInlineWarningsAndErrors]=useLocalStorageWithLog<boolean>(LOCAL_STORAGE_SHOW_INLINE_WARNINGS_AND_ERRORS_KEY,true,);const[traceUpdatesEnabled,setTraceUpdatesEnabled]=useLocalStorageWithLog<boolean>(LOCAL_STORAGE_TRACE_UPDATES_ENABLED_KEY,false,);constdocumentElements=useMemo<DocumentElements>(()=>{constarray:Array<HTMLElement>=[((document.documentElement:any):HTMLElement),];if(componentsPortalContainer!=null){array.push(((componentsPortalContainer.ownerDocument.documentElement:any):HTMLElement),);}if(profilerPortalContainer!=null){array.push(((profilerPortalContainer.ownerDocument.documentElement:any):HTMLElement),);}returnarray;},[componentsPortalContainer,profilerPortalContainer]);useLayoutEffect(()=>{switch(displayDensity){case'comfortable':updateDisplayDensity('comfortable',documentElements);break;case'compact':updateDisplayDensity('compact',documentElements);break;default:throwError(`UnsupporteddisplayDensityvalue"${displayDensity}"`);}},[displayDensity,documentElements]);useLayoutEffect(()=>{switch(theme){case'light':updateThemeVariables('light',documentElements);break;case'dark':updateThemeVariables('dark',documentElements);break;case'auto':updateThemeVariables(browserTheme,documentElements);break;default:throwError(`Unsupportedthemevalue"${theme}"`);}},[browserTheme,theme,documentElements]);useEffect(()=>{bridge.send('updateConsolePatchSettings',{appendComponentStack,breakOnConsoleErrors,showInlineWarningsAndErrors,hideConsoleLogsInStrictMode,browserTheme,});},[bridge,appendComponentStack,breakOnConsoleErrors,showInlineWarningsAndErrors,hideConsoleLogsInStrictMode,browserTheme,]);useEffect(()=>{bridge.send('setTraceUpdatesEnabled',traceUpdatesEnabled);},[bridge,traceUpdatesEnabled]);constvalue=useMemo(()=>({appendComponentStack,breakOnConsoleErrors,displayDensity,lineHeight:displayDensity==='compact'?COMPACT_LINE_HEIGHT:COMFORTABLE_LINE_HEIGHT,parseHookNames,setAppendComponentStack,setBreakOnConsoleErrors,setDisplayDensity,setParseHookNames,setTheme,setTraceUpdatesEnabled,setShowInlineWarningsAndErrors,showInlineWarningsAndErrors,setHideConsoleLogsInStrictMode,hideConsoleLogsInStrictMode,theme,browserTheme,traceUpdatesEnabled,}),[appendComponentStack,breakOnConsoleErrors,displayDensity,parseHookNames,setAppendComponentStack,setBreakOnConsoleErrors,setDisplayDensity,setParseHookNames,setTheme,setTraceUpdatesEnabled,setShowInlineWarningsAndErrors,showInlineWarningsAndErrors,setHideConsoleLogsInStrictMode,hideConsoleLogsInStrictMode,theme,browserTheme,traceUpdatesEnabled,],);return(<SettingsContext.Providervalue={value}>{children}</SettingsContext.Provider>);}exportfunctionupdateDisplayDensity(displayDensity:DisplayDensity,documentElements:DocumentElements,):void{//Sizesandpaddings/marginsareallrem-based,//soupdatetherootfont-sizeaswellwhenthedisplaypreferencechanges.constcomputedStyle=getComputedStyle((document.body:any));constfontSize=computedStyle.getPropertyValue(`--${displayDensity}-root-font-size`,);constroot=((document.querySelector(':root'):any):HTMLElement);root.style.fontSize=fontSize;}exportfunctionupdateThemeVariables(theme:Theme,documentElements:DocumentElements,):void{//Updatescrollbarcolortomatchtheme.//thisCSSpropertyiscurrentlyonlysupportedinFirefox,//butitmakesasignificantUIimprovementindarkmode.//https://developer.mozilla.org/en-US/docs/Web/CSS/scrollbar-colordocumentElements.forEach(documentElement=>{//$FlowFixMe[prop-missing]scrollbarColorismissinginCSSStyleDeclarationdocumentElement.style.scrollbarColor=`var(${`--${theme}-color-scroll-thumb`})var(${`--${theme}-color-scroll-track`})`;});}export{SettingsContext,SettingsContextController};
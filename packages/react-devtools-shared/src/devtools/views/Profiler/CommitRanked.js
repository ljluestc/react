/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**@flow*/import*asReactfrom'react';import{useCallback,useContext,useMemo,useState}from'react';importAutoSizerfrom'react-virtualized-auto-sizer';import{FixedSizeList}from'react-window';import{ProfilerContext}from'./ProfilerContext';importNoCommitDatafrom'./NoCommitData';importCommitRankedListItemfrom'./CommitRankedListItem';importHoveredFiberInfofrom'./HoveredFiberInfo';import{scale}from'./utils';import{StoreContext}from'../context';import{SettingsContext}from'../Settings/SettingsContext';import{useHighlightNativeElement}from'../hooks';importTooltipfrom'./Tooltip';importstylesfrom'./CommitRanked.css';importtype{TooltipFiberData}from'./HoveredFiberInfo';importtype{ChartData}from'./RankedChartBuilder';importtype{CommitTree}from'./types';exporttypeItemData={chartData:ChartData,onElementMouseEnter:(fiberData:TooltipFiberData)=>void,onElementMouseLeave:()=>void,scaleX:(value:number,fallbackValue:number)=>number,selectedFiberID:number|null,selectedFiberIndex:number,selectFiber:(id:number|null,name:string|null)=>void,width:number,};exportdefaultfunctionCommitRankedAutoSizer(_:{}):React.Node{const{profilerStore}=useContext(StoreContext);const{rootID,selectedCommitIndex,selectFiber}=useContext(ProfilerContext);const{profilingCache}=profilerStore;constdeselectCurrentFiber=useCallback((event:$FlowFixMe)=>{event.stopPropagation();selectFiber(null,null);},[selectFiber],);letcommitTree:CommitTree|null=null;letchartData:ChartData|null=null;if(selectedCommitIndex!==null){commitTree=profilingCache.getCommitTree({commitIndex:selectedCommitIndex,rootID:((rootID:any):number),});chartData=profilingCache.getRankedChartData({commitIndex:selectedCommitIndex,commitTree,rootID:((rootID:any):number),});}if(commitTree!=null&&chartData!=null&&chartData.nodes.length>0){return(<divclassName={styles.Container}onClick={deselectCurrentFiber}><AutoSizer>{({height,width})=>(<CommitRankedchartData={((chartData:any):ChartData)}commitTree={((commitTree:any):CommitTree)}height={height}width={width}/>)}</AutoSizer></div>);}else{return<NoCommitData/>;}}typeProps={chartData:ChartData,commitTree:CommitTree,height:number,width:number,};functionCommitRanked({chartData,commitTree,height,width}:Props){const[hoveredFiberData,setHoveredFiberData]=useState<TooltipFiberData|null>(null);const{lineHeight}=useContext(SettingsContext);const{selectedFiberID,selectFiber}=useContext(ProfilerContext);const{highlightNativeElement,clearHighlightNativeElement}=useHighlightNativeElement();constselectedFiberIndex=useMemo(()=>getNodeIndex(chartData,selectedFiberID),[chartData,selectedFiberID],);consthandleElementMouseEnter=useCallback(({id,name}:$FlowFixMe)=>{highlightNativeElement(id);//Highlightlasthoveredelement.setHoveredFiberData({id,name});//Sethoveredfiberdatafortooltip},[highlightNativeElement],);consthandleElementMouseLeave=useCallback(()=>{clearHighlightNativeElement();//clearhighlightingofelementonmouseleavesetHoveredFiberData(null);//clearhoveredfiberdatafortooltip},[clearHighlightNativeElement]);constitemData=useMemo<ItemData>(()=>({chartData,onElementMouseEnter:handleElementMouseEnter,onElementMouseLeave:handleElementMouseLeave,scaleX:scale(0,chartData.nodes[selectedFiberIndex].value,0,width),selectedFiberID,selectedFiberIndex,selectFiber,width,}),[chartData,handleElementMouseEnter,handleElementMouseLeave,selectedFiberID,selectedFiberIndex,selectFiber,width,],);//TooltipusedtoshowsummaryoffiberinfoonhoverconsttooltipLabel=useMemo(()=>hoveredFiberData!==null?(<HoveredFiberInfofiberData={hoveredFiberData}/>):null,[hoveredFiberData],);return(<Tooltiplabel={tooltipLabel}><FixedSizeListheight={height}innerElementType="svg"itemCount={chartData.nodes.length}itemData={itemData}itemSize={lineHeight}width={width}>{CommitRankedListItem}</FixedSizeList></Tooltip>);}constgetNodeIndex=(chartData:ChartData,id:number|null):number=>{if(id===null){return0;}const{nodes}=chartData;for(letindex=0;index<nodes.length;index++){if(nodes[index].id===id){returnindex;}}return0;};
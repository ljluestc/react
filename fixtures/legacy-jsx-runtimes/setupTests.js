'usestrict';//ThisismostlycopypastafromtoWarnDev.jsmatchers//thatweuseinthemainrepoJestconfiguration.constexpect=global.expect;const{diff:jestDiff}=require('jest-diff');constutil=require('util');functionshouldIgnoreConsoleError(format,args){if(process.env.NODE_ENV!=='production'){if(typeofformat==='string'){if(format.indexOf('Error:Uncaught[')===0){//ThislookslikeanuncaughterrorfrominvokeGuardedCallback()wrapper//indevelopmentthatisreportedbyjsdom.Ignorebecauseit'snoisy.returntrue;}if(format.indexOf('Theaboveerroroccurred')===0){//ThislookslikeanerroraddendumfromReactFiberErrorLogger.//Ignoreittoo.returntrue;}}}else{if(format!=null&&typeofformat.message==='string'&&typeofformat.stack==='string'&&args.length===0){//Inproduction,ReactFiberErrorLoggerlogserrorobjectsdirectly.//Theyarenoisytoosowe'lltrytoignorethem.returntrue;}}//Lookslegitreturnfalse;}functionnormalizeCodeLocInfo(str){if(typeofstr!=='string'){returnstr;}//Thisspecialcaseexistsonlyforthespecialsourcelocationin//ReactElementValidator.Thatwillgoawayifweremovesourcelocations.str=str.replace(/Checkyourcodeat.+?:\d+/g,'Checkyourcodeat**');//V8format://atComponent(/path/filename.js:123:45)//Reactformat://inComponent(atfilename.js:123)returnstr.replace(/\n+(?:at|in)([\S]+)[^\n]*/g,function(m,name){return'\nin'+name+'(at**)';});}constcreateMatcherFor=(consoleMethod,matcherName)=>functionmatcher(callback,expectedMessages,options={}){if(process.env.NODE_ENV!=='production'){//Warnaboutincorrectusageofmatcher.if(typeofexpectedMessages==='string'){expectedMessages=[expectedMessages];}elseif(!Array.isArray(expectedMessages)){throwError(`${matcherName}()requiresaparameteroftypestringoranarrayofstrings`+`butwasgiven${typeofexpectedMessages}.`);}if(options!=null&&(typeofoptions!=='object'||Array.isArray(options))){thrownewError(`${matcherName}()secondargument,whenpresent,shouldbeanobject.`+'Didyouforgettowrapthemessagesintoanarray?');}if(arguments.length>3){//`matcher`comesfromJest,soit'smorethan2inpracticethrownewError(`${matcherName}()receivedmorethantwoarguments.`+'Didyouforgettowrapthemessagesintoanarray?');}constwithoutStack=options.withoutStack;constlogAllErrors=options.logAllErrors;constwarningsWithoutComponentStack=[];constwarningsWithComponentStack=[];constunexpectedWarnings=[];letlastWarningWithMismatchingFormat=null;letlastWarningWithExtraComponentStack=null;//Catcherrorsthrownbythecallback,//Butonlyrethrowthemifalltestexpectationshavebeensatisfied.//OtherwiseanErrorinthecallbackcanmaskafailedexpectation,//andresultinatestthatpasseswhenitshouldn't.letcaughtError;constisLikelyAComponentStack=message=>typeofmessage==='string'&&(message.includes('\nin')||message.includes('\nat'));constconsoleSpy=(format,...args)=>{//Ignoreuncaughterrorsreportedbyjsdom//andReactaddendumsbecausethey'retoonoisy.if(!logAllErrors&&consoleMethod==='error'&&shouldIgnoreConsoleError(format,args)){return;}constmessage=util.format(format,...args);constnormalizedMessage=normalizeCodeLocInfo(message);//Rememberifthenumberof%sinterpolations//doesn'tmatchthenumberofarguments.//We'llfailthetestifithappens.letargIndex=0;format.replace(/%s/g,()=>argIndex++);if(argIndex!==args.length){lastWarningWithMismatchingFormat={format,args,expectedArgCount:argIndex,};}//Protectagainstaccidentallypassingacomponentstack//towarning()whichalreadyinjectsthecomponentstack.if(args.length>=2&&isLikelyAComponentStack(args[args.length-1])&&isLikelyAComponentStack(args[args.length-2])){lastWarningWithExtraComponentStack={format,};}for(letindex=0;index<expectedMessages.length;index++){constexpectedMessage=expectedMessages[index];if(normalizedMessage===expectedMessage||normalizedMessage.includes(expectedMessage)){if(isLikelyAComponentStack(normalizedMessage)){warningsWithComponentStack.push(normalizedMessage);}else{warningsWithoutComponentStack.push(normalizedMessage);}expectedMessages.splice(index,1);return;}}leterrorMessage;if(expectedMessages.length===0){errorMessage='Unexpectedwarningrecorded:'+this.utils.printReceived(normalizedMessage);}elseif(expectedMessages.length===1){errorMessage='Unexpectedwarningrecorded:'+jestDiff(expectedMessages[0],normalizedMessage);}else{errorMessage='Unexpectedwarningrecorded:'+jestDiff(expectedMessages,[normalizedMessage]);}//Recordthecallstackforunexpectedwarnings.//Wedon'tthrowanErrorherethough,//BecauseitmightbesuppressedbyReactFiberScheduler.unexpectedWarnings.push(newError(errorMessage));};//TODODecidewhetherweneedtosupportnestedtoWarn*expectations.//Ifwedon'tneedit,addacheckheretoseeifthisisalreadyourspy,//Andthrowanerror.constoriginalMethod=console[consoleMethod];//AvoidusingJest'sbuilt-inspysinceitcan'tberemoved.console[consoleMethod]=consoleSpy;try{callback();}catch(error){caughtError=error;}finally{//Restoretheunspiedmethodsothatunexpectederrorsfailtests.console[consoleMethod]=originalMethod;//AnyunexpectedErrorsthrownbythecallbackshouldfailthetest.//Thisshouldtakeprecedencesinceunexpectederrorscouldblockwarnings.if(caughtError){throwcaughtError;}//Anyunexpectedwarningsshouldbetreatedasafailure.if(unexpectedWarnings.length>0){return{message:()=>unexpectedWarnings[0].stack,pass:false,};}//Anyremainingmessagesindicateafailedexpectations.if(expectedMessages.length>0){return{message:()=>`Expectedwarningwasnotrecorded:\n${this.utils.printReceived(expectedMessages[0])}`,pass:false,};}if(typeofwithoutStack==='number'){//We'reexpectingaparticularnumberofwarningswithoutstacks.if(withoutStack!==warningsWithoutComponentStack.length){return{message:()=>`Expected${withoutStack}warningswithoutacomponentstackbutreceived${warningsWithoutComponentStack.length}:\n`+warningsWithoutComponentStack.map(warning=>this.utils.printReceived(warning)),pass:false,};}}elseif(withoutStack===true){//We'reexpectingthatallwarningswon'thavethestack.//Ifsomewarningshaveit,it'sanerror.if(warningsWithComponentStack.length>0){return{message:()=>`Receivedwarningunexpectedlyincludesacomponentstack:\n${this.utils.printReceived(warningsWithComponentStack[0])}\nIfthiswarningintentionallyincludesthecomponentstack,remove`+`{withoutStack:true}fromthe${matcherName}()call.Ifyouhaveamixof`+`warningswithandwithoutstackinone${matcherName}()call,pass`+`{withoutStack:N}whereNisthenumberofwarningswithoutstacks.`,pass:false,};}}elseif(withoutStack===false||withoutStack===undefined){//We'reexpectingthatallwarnings*do*havethestack(default).//Ifsomewarningsdon'thaveit,it'sanerror.if(warningsWithoutComponentStack.length>0){return{message:()=>`Receivedwarningunexpectedlydoesnotincludeacomponentstack:\n${this.utils.printReceived(warningsWithoutComponentStack[0])}\nIfthiswarningintentionallyomitsthecomponentstack,add`+`{withoutStack:true}tothe${matcherName}call.`,pass:false,};}}else{throwError(`Thesecondargumentfor${matcherName}(),whenspecified,mustbeanobject.Itmayhavea`+`propertycalled"withoutStack"whosevaluemaybeundefined,boolean,oranumber.`+`Insteadreceived${typeofwithoutStack}.`);}if(lastWarningWithMismatchingFormat!==null){return{message:()=>`Received${lastWarningWithMismatchingFormat.args.length}argumentsforamessagewith${lastWarningWithMismatchingFormat.expectedArgCount}placeholders:\n${this.utils.printReceived(lastWarningWithMismatchingFormat.format)}`,pass:false,};}if(lastWarningWithExtraComponentStack!==null){return{message:()=>`Receivedmorethanonecomponentstackforawarning:\n${this.utils.printReceived(lastWarningWithExtraComponentStack.format)}\nDidyouaccidentallypassastacktowarning()asthelastargument?`+`Don'tforgetwarning()alreadyinjectsthecomponentstackautomatically.`,pass:false,};}return{pass:true};}}else{//Anyuncaughterrorsorwarningsshouldfailtestsinproductionmode.callback();return{pass:true};}};expect.extend({toWarnDev:createMatcherFor('warn','toWarnDev'),toErrorDev:createMatcherFor('error','toErrorDev'),});
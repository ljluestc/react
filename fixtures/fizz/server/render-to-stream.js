/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**/import*asReactfrom'react';import{renderToPipeableStream}from'react-dom/server';importAppfrom'../src/App';import{ABORT_DELAY}from'./delays';//Inarealsetup,you'dreaditfromwebpackbuildstats.letassets={'main.js':'/main.js','main.css':'/main.css',};module.exports=functionrender(url,res){//Thenewwiringisabitmoreinvolved.res.socket.on('error',error=>{console.error('Fatal',error);});letdidError=false;letdidFinish=false;const{pipe,abort}=renderToPipeableStream(<Appassets={assets}/>,{bootstrapScripts:[assets['main.js']],onAllReady(){//Fullcompletion.//YoucanusethisforSSGorcrawlers.didFinish=true;},onShellReady(){//Ifsomethingerroredbeforewestartedstreaming,wesettheerrorcodeappropriately.res.statusCode=didError?500:200;res.setHeader('Content-type','text/html');setImmediate(()=>pipe(res));},onShellError(x){//Somethingerroredbeforewecouldcompletetheshellsoweemitanalternativeshell.res.statusCode=500;res.send('<!doctype><p>Error</p>');},onError(x){didError=true;console.error(x);},});//Abandonandswitchtoclientrenderingifenoughtimepasses.//Tryloweringthistoseetheclientrecover.setTimeout(()=>{if(!didFinish){abort();}},ABORT_DELAY);};
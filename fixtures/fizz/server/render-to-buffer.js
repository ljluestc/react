/***Copyright(c)MetaPlatforms,Inc.andaffiliates.**ThissourcecodeislicensedundertheMITlicensefoundinthe*LICENSEfileintherootdirectoryofthissourcetree.**/import{Writable}from'stream';import*asReactfrom'react';import{renderToPipeableStream}from'react-dom/server';importAppfrom'../src/App';import{ABORT_DELAY}from'./delays';//Inarealsetup,you'dreaditfromwebpackbuildstats.letassets={'main.js':'/main.js','main.css':'/main.css',};functionHtmlWritable(options){Writable.call(this,options);this.chunks=[];this.html='';}HtmlWritable.prototype=Object.create(Writable.prototype);HtmlWritable.prototype.getHtml=functiongetHtml(){returnthis.html;};HtmlWritable.prototype._write=function_write(chunk,encoding,callback){this.chunks.push(chunk);callback();};HtmlWritable.prototype._final=function_final(callback){this.html=Buffer.concat(this.chunks).toString();callback();};module.exports=functionrender(url,res){letwritable=newHtmlWritable();res.socket.on('error',error=>{console.error('Fatal',error);});letdidError=false;letdidFinish=false;writable.on('finish',()=>{//Ifsomethingerroredbeforewestartedstreaming,wesettheerrorcodeappropriately.res.statusCode=didError?500:200;res.setHeader('Content-type','text/html');res.send(writable.getHtml());});const{pipe,abort}=renderToPipeableStream(<Appassets={assets}/>,{bootstrapScripts:[assets['main.js']],onAllReady(){//Fullcompletion.//YoucanusethisforSSGorcrawlers.didFinish=true;},onShellReady(){//Ifsomethingerroredbeforewestartedstreaming,wesettheerrorcodeappropriately.pipe(writable);},onShellError(x){//Somethingerroredbeforewecouldcompletetheshellsoweemitanalternativeshell.res.statusCode=500;res.send('<!doctype><p>Error</p>');},onError(x){didError=true;console.error(x);},});//Abandonandswitchtoclientrenderingifenoughtimepasses.//Tryloweringthistoseetheclientrecover.setTimeout(()=>{if(!didFinish){abort();}},ABORT_DELAY);};
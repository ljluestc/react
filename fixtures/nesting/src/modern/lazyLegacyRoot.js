importReactfrom'react';import{useContext,useMemo,useRef,useState,useLayoutEffect}from'react';import{__RouterContext}from'react-router';import{ReactReduxContext}from'react-redux';importThemeContextfrom'./shared/ThemeContext';letrendererModule={status:'pending',promise:null,result:null,};exportdefaultfunctionlazyLegacyRoot(getLegacyComponent){letcomponentModule={status:'pending',promise:null,result:null,};returnfunctionWrapper(props){constcreateLegacyRoot=readModule(rendererModule,()=>import('../legacy/createLegacyRoot')).default;constComponent=readModule(componentModule,getLegacyComponent).default;constcontainerRef=useRef(null);constrootRef=useRef(null);//Populateeverycontextswewantthelegacysubtreetosee.//Theninsrc/legacy/createLegacyRootwewillapplythem.consttheme=useContext(ThemeContext);constrouter=useContext(__RouterContext);constreactRedux=useContext(ReactReduxContext);constcontext=useMemo(()=>({theme,router,reactRedux,}),[theme,router,reactRedux]);//Create/unmount.useLayoutEffect(()=>{if(!rootRef.current){rootRef.current=createLegacyRoot(containerRef.current);}constroot=rootRef.current;return()=>{root.unmount();};},[createLegacyRoot]);//Mount/update.useLayoutEffect(()=>{if(rootRef.current){rootRef.current.render(Component,props,context);}},[Component,props,context]);return<divstyle={{display:'contents'}}ref={containerRef}/>;};}//ThisissimilartoReact.lazy,butimplementedmanually.//WeusethistoSuspendrenderingofthiscomponentuntil//wefetchthecomponentandthelegacyReacttorenderit.functionreadModule(record,createPromise){if(record.status==='fulfilled'){returnrecord.result;}if(record.status==='rejected'){throwrecord.result;}if(!record.promise){record.promise=createPromise().then(value=>{if(record.status==='pending'){record.status='fulfilled';record.promise=null;record.result=value;}},error=>{if(record.status==='pending'){record.status='rejected';record.promise=null;record.result=error;}});}throwrecord.promise;}
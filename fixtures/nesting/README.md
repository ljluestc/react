#NestedReactDemoThisisademoofhowyoucanconfigureabuildsystemtoserve**twodifferentversionsofReact**sidebysideinthesameapp.Thisisnotoptimal,andshouldonlybeusedasacompromisetopreventyourappfromgettingstuckonanoldversionofReact.##YouProbablyDon'tNeedThisNotethat**thisapproachismeanttobeanescapehatch,notthenorm**.Normally,weencourageyoutouseasingleversionofReactacrossyourwholeapp.WhenyouneedtoupgradeReact,itisbettertotrytoupgradeitallatonce.Wetrytokeepbreakingchangesbetweenversionstotheminimum,andoftenthereareautomaticscripts("codemods")thatcanassistyouwithmigration.Youcanalwaysfindthemigrationinformationforanyreleaseon[ourblog](https://reactjs.org/blog/).UsingasingleversionofReactremovesalotofcomplexity.Itisalsoessentialtoensurethebestexperienceforyouruserswhodon'thavetodownloadthecodetwice.AlwayspreferusingoneReact.##WhatIsThisFor?However,forsomeappsthathavebeeninproductionformanyyears,upgradingallscreensatoncemaybeprohibitivelydifficult.Forexample,Reactcomponentswrittenin2014maystillrelyon[theunofficiallegacycontextAPI](https://reactjs.org/docs/legacy-context.html)(nottobeconfusedwiththemodernone),andarenotalwaysmaintained.Traditionally,thismeantthatifalegacyAPIisdeprecated,youwouldbestuckontheoldversionofReactforever.Thatpreventsyourwholeappfromreceivingimprovementsandbugfixes.Thisrepositorydemonstratesahybridapproach.ItshowshowyoucanuseanewerversionofReactforsomepartsofyourapp,while**lazy-loadinganolderversionofReact**forthepartsthathaven'tbeenmigratedyet.Thisapproachisinherentlymorecomplex,andshouldbeusedasalastresortwhenyoucan'tupgrade.##VersionRequirementsThisdemousestwodifferentversionsofReact:React17for"modern"components(in`src/modern`),andReact16.8for"legacy"components(in`src/legacy`).**WestillrecommendupgradingyourwholeapptoReact17inonepiece.**TheReact17releaseintentionallyhasminimalbreakingchangessothatit'seasiertoupgradeto.Inparticular,React17solvessomeproblemswithnestingrelatedtoeventpropagationthatearlierversionsofReactdidnothandlewell.WeexpectthatthisnestingdemomaynotbeasusefultodayasduringafuturemigrationfromReact17tothefuturemajorversionswheresomeofthelong-deprecatedAPIsmayberemoved.However,ifyou'realreadystuckonanoldversionofReact,youmayfoundthisapproachusefultoday.IfyouremoveaHookcallfrom`src/shared/Clock.js`,youcandowngradethelegacyReactallthewaydowntoReact16.3.IfyouthenremoveContextAPIusagefrom`src/legacy/createLegacyRoot.js`,youcanfurtherdowngradethelegacyReactversion,butkeepinmindthattheusageofthird-partylibrariesincludedinthisdemo(ReactRouterandReactRedux)mayneedtobeadjustedorremoved.##InstallationTorunthisdemo,openitsfolderinTerminalandexecute:```shnpminstallnpmstart```Ifyouwanttotesttheproductionbuild,youcanruninstead:```npminstallnpmrunbuildnpxserve-sbuild```Thissampleappusesclient-sideroutingandconsistsoftworoutes:-`/`rendersapagewhichusesanewerversionofReact.(Intheproductionbuild,youcanverifythatonlyoneversionofReactisbeingloadedwhenthisrouteisrendered.)-`/about`rendersapagewhichusesanolderversionofReactforapartofitstree.(Intheproductionbuild,youcanverifythatbothversionsofReactareloadedfromdifferentchunks.)**Thepurposeofthisdemoistoshowsomenuancesofsuchsetup:**-HowtoinstalltwoversionsofReactinasingleappwithnpmsidebyside.-Howtoavoidthe["invalidHookcall"error](https://github.com/facebook/react/issues/13991)whilenestingReacttrees.-HowtopasscontextbetweendifferentversionsofReact.-Howtolazy-loadthesecondReactbundlesoit'sonlyloadedonthescreensthatuseit.-Howtodoallofthiswithoutaspecialbundlerconfiguration.##HowItWorksFilestructureisextremelyimportantinthisdemo.IthasadirecteffectonwhichcodeisgoingtousewhichversionofReact.ThisparticulardemoisusingCreateReactAppwithoutejecting,so**itdoesn'trelyonanybundlerpluginsorconfiguration**.Theprincipleofthisdemoisportabletoothersetups.###DependenciesWewillusethreedifferent`package.json`s:onefornon-Reactcodeattheroot,andtwointherespective`src/legacy`and`src/modern`foldersthatspecifytheReactdependencies:-**`package.json`**:Theroot`package.json`isaplaceforbuilddependencies(suchas`react-scripts`)andanyReact-agnosticlibraries(forexample,`lodash`,`immer`,or`redux`).Wedo**not**includeReactoranyReact-relatedlibrariesinthisfile.-**`src/legacy/package.json`**:Thisiswherewedeclarethe`react`and`react-dom`dependenciesforthe"legacy"trees.Inthisdemo,we'reusingReact16.8(although,asnotedabove,wecoulddowngradeitfurtherbelow).Thisis**also**wherewespecifyanythird-partylibrariesthatuseReact.Forexample,weinclude`react-router`and`react-redux`inthisexample.-**`src/modern/package.json`**:Thisiswherewedeclarethe`react`and`react-dom`dependenciesforthe"modern"trees.Inthisdemo,we'reusingReact17.Here,wealsospecifythird-partydependenciesthatuseReactandareusedfromthemodernpartofourapp.Thisiswhywe*also*have`react-router`and`react-redux`inthisfile.(Theirversionsdon'tstrictlyhavetomatchtheir`legacy`counterparts,butfeaturesthatrelyoncontextmayrequireworkaroundsiftheydiffer.)The`scripts`intheroot`package.json`aresetupsothatwhenyourun`npminstall`init,italsoruns`npmintall`inboth`src/legacy`and`src/modern`folders.**Note:**Thisdemoissetuptouseafewthird-partydependencies(ReactRouterandRedux).Thesearenotessential,andyoucanremovethemfromthedemo.Theyareincludedsowecanshowhowtomakethemworkwiththisapproach.###FoldersThereareafewkeyfoldersinthisexample:-**`src`**:Rootofthesourcetree.Atthislevel(orbelowit,exceptforthespecialfoldersnotedbelow),youcanputanylogicthat'sagnosticofReact.Forexample,inthisdemowehave`src/index.js`whichistheapp'sentrypoint,and`src/store.js`whichexportsaReduxstore.Theseregularmodulesonlyexecuteonce,andare**not**duplicatedbetweenthebundles.-**`src/legacy`**:ThisiswhereallthecodeusingtheolderversionofReactshouldgo.ThisincludesReactcomponentsandHooks,andgeneralproductcodethatis**only**usedbythelegacytrees.-**`src/modern`**:ThisiswhereallthecodeusingthenewerversionofReactshouldgo.ThisincludesReactcomponentsandHooks,andgeneralproductcodethatis**only**usedbythemoderntrees.-**`src/shared`**:YoumayhavesomecomponentsorHooksthatyouwishtousefrombothmodernandlegacysubtrees.Thebuildprocessissetupsothat**everythinginside`src/shared`getscopiedbyafilewatcher**intoboth`src/legacy/shared`and`src/modern/shared`oneverychange.ThisletsyouwriteacomponentoraHookonce,butreuseitinbothplaces.###LazyLoadingLoadingtwoReactsonthesamepageisbadfortheuserexperience,soyoushouldstrivetopushthisasfaraspossiblefromthecriticalpathofyourapp.Forexample,ifthereisadialogthatislesscommonlyused,oraroutethatisrarelyvisited,thosearebettercandidatesforstayingonanolderversionofReactthanpartsofyourhomepage.ToencourageonlyloadingtheolderReactwhennecessary,thisdemoincludesahelperthatworkssimilarlyto`React.lazy`.Forexample,`src/modern/AboutPage.js`,simplified,lookslikethis:```jsimportlazyLegacyRootfrom'./lazyLegacyRoot';//Lazy-loadacomponentfromthebundleusinglegacyReact.constGreeting=lazyLegacyRoot(()=>import('../legacy/Greeting'));functionAboutPage(){return(<><h3>ThiscomponentisrenderedbyReact({React.version}).</h3><Greeting/></>);}```Asaresult,onlyifthe`AboutPage`(andasaresult,`<Greeting/>`)getsrendered,wewillloadthebundlecontainingthelegacyReactandthelegacy`Greeting`component.Likewith`React.lazy()`,wewrapitin`<Suspense>`tospecifytheloadingindicator:```js<Suspensefallback={<Spinner/>}><AboutPage/></Suspense>```Ifthelegacycomponentisonlyrenderedconditionally,wewon'tloadthesecondReactuntilit'sshown:```js<><buttononClick={()=>setShowGreeting(true)}>Sayhi</button>{showGreeting&&(<Suspensefallback={<Spinner/>}><Greeting/></Suspense>)}</>```Theimplementationofthe`src/modern/lazyLegacyRoot.js`helperisincludedsoyoucantweakitandcustomizeittoyourneeds.Remembertotestlazyloadingwiththeproductionbuildsbecausethebundlermaynotoptimizeitindevelopment.###ContextIfyouhavenestedtreesmanagedbydifferentversionsofReact,theinnertreewon't"see"theoutertree'sContext.Thisbreaksthird-partylibrarieslikeReactReduxorReactRouter,aswellasanyofyourownusageofContext(forexample,fortheming).Tosolvethisproblem,wereadalltheContextswecareaboutintheoutertree,passthemtotheinnertree,andthenwraptheinnertreeinthecorrespondingProviders.Youcanseethisinactionintwofiles:*`src/modern/lazyLegacyRoot.js`:Lookfor`useContext`calls,andhowtheirresultsarecombinedintoasingleobjectthatispassedthrough.**YoucanreadmoreContextsthere**ifyourapprequiresthem.*`src/legacy/createLegacyRoot.js`:Lookforthe`Bridge`componentwhichreceivesthatobjectandwrapsitschildrenwiththeappropriateContextProviders.**YoucanwrapthemwithmoreProvidersthere**ifyourapprequiresthem.Notethat,generallysaying,thisapproachissomewhatfragile,especiallybecausesomelibrariesmaynotexposetheirContextsofficiallyorconsidertheirstructureprivate.YoumaybeabletoexposeprivateContextsbyusingatoollike[patch-package](https://www.npmjs.com/package/patch-package),butremembertokeepalltheversionspinnedbecauseevenapatchreleaseofathird-partylibrarymaychangethebehavior.###NestingDirectionInthisdemo,weuseanolderReactinsideanappmanagedbythenewerReact.However,wecouldrenamethefoldersandapplythesameapproachintheotherdirection.###EventPropagationNotethatbeforeReact17,`event.stopPropagation()`intheinnerReacttreedoesnotpreventtheeventpropagationtotheouterReacttree.ThismaycauseunexpectedbehaviorwhenextractingaUItreelikeadialogtouseaseparateReact.ThisisbecausepriortoReact17,bothReactswouldattachtheeventlisteneratthe`document`level.React17fixesthisbyattachinghandlerstotheroots.WestronglyrecommendupgradingtoReact17beforeconsideringthenestingstrategyforfutureupgrades.###GotchasThissetupisunusual,soithasafewgotchas.*Don'tadd`package.json`tothe`src/shared`folder.Forexample,ifyouwanttouseannpmReactcomponentinside`src/shared`,youshouldaddittoboth`src/modern/package.json`and`src/legacy/package.json`instead.Youcanusedifferentversionsofitbutmakesureyourcodeworkswithbothofthemâ€”andthatitworkswithbothReacts!*Don'tuseReactoutsideofthe`src/modern`,`src/legacy`,or`src/shared`.Don'taddReact-relatedlibrariesoutsideof`src/modern/package.json`or`src/legacy/package.json`.*Rememberthat`src/shared`iswhereyouwritesharedcomponents,butthefilesyouwritethereareautomaticallycopiedinto`src/modern/shared`and`src/legacy/shared`,**fromwhichyoushouldimportthem**.Bothofthetargetdirectoriesarein`.gitignore`.Importingdirectlyfrom`src/shared`**willnotwork**becauseitisambiguouswhat`react`referstointhatfolder.*Keepinmindthatanycodein`src/shared`getsduplicatedbetweenthelegacyandthemodernbundles.Codethatshouldnotbeduplicatedneedstobeanywhereelsein`src`(butyoucan'tuseReacttheresincetheversionisambiguous).*You'llwanttoexclude`src/*/node_modules`fromyourlinter'sconfiguration,asthisdemodoesin`.eslintignorerc`.Thissetupiscomplicated,andwedon'trecommenditformostapps.However,webelieveitisimportanttoofferitasanoptionforappsthatwouldotherwisegetleftbehind.Theremightbewaystosimplifyitwithalayeroftooling,butthisexampleisintentionallyshowingthelow-levelmechanismthatothertoolsmaybuildon.
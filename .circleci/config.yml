version:2.1aliases:-&docker-image:cimg/openjdk:18.0-node-&environmentTZ:/usr/share/zoneinfo/America/Los_Angeles-&restore_yarn_cache_fixtures_domrestore_cache:name:Restoreyarncacheforfixtures/domkeys:-v2-yarn_cache-{{arch}}-{{checksum"yarn.lock"}}-fixtures/dom-&yarn_install_fixtures_domrun:name:Installdependenciesinfixtures/domworking_directory:fixtures/domcommand:yarninstall--frozen-lockfile--cache-folder~/.cache/yarn-&yarn_install_fixtures_dom_retryrun:name:Installdependenciesinfixtures/dom(retry)when:on_failworking_directory:fixtures/domcommand:yarninstall--frozen-lockfile--cache-folder~/.cache/yarn-&save_yarn_cache_fixtures_domsave_cache:name:Saveyarncacheforfixtures/domkey:v2-yarn_cache-{{arch}}-{{checksum"yarn.lock"}}-fixtures/dompaths:-~/.cache/yarn-&TEST_PARALLELISM20-&attach_workspaceat:buildcommands:setup_node_modules:description:"Restorenode_modules"steps:-restore_cache:name:Restoreyarncachekeys:-v2-yarn_cache-{{arch}}-{{checksum"yarn.lock"}}-run:name:Installdependenciescommand:|yarninstall--frozen-lockfile--cache-folder~/.cache/yarnif[$?-ne0];thenyarninstall--frozen-lockfile--cache-folder~/.cache/yarnfi-save_cache:name:Saveyarncachekey:v2-yarn_cache-{{arch}}-{{checksum"yarn.lock"}}paths:-~/.cache/yarn#TheCircleCIAPIdoesn'tyetsupporttriggeringaspecificworkflow,butit#doessupporttriggeringapipeline.Soasaworkaroundyoucantrigggerthe#entirepipelineanduseparameterstodisableeverythingexcepttheworkflow#youwant.CircleCIrecommendsthisworkaroundhere:#https://support.circleci.com/hc/en-us/articles/360050351292-How-to-trigger-a-workflow-via-CircleCI-API-v2-parameters:#ThisisonlysetwhentriggeringtheCIpipelineviaanAPIrequest.prerelease_commit_sha:type:stringdefault:''jobs:yarn_lint:docker:*dockerenvironment:*environmentsteps:-checkout-setup_node_modules-run:node./scripts/prettier/index-run:node./scripts/tasks/eslint-run:./scripts/circleci/check_license.sh-run:./scripts/circleci/check_modules.sh-run:./scripts/circleci/test_print_warnings.shyarn_flow:docker:*dockerenvironment:*environmentparallelism:5steps:-checkout-setup_node_modules-run:node./scripts/tasks/flow-ciscrape_warning_messages:docker:*dockerenvironment:*environmentsteps:-checkout-setup_node_modules-run:command:|mkdir-p./buildnode./scripts/print-warnings/print-warnings.js>build/WARNINGS-persist_to_workspace:root:.paths:-buildyarn_build:docker:*dockerenvironment:*environmentparallelism:40steps:-checkout-setup_node_modules-run:yarnbuild-persist_to_workspace:root:.paths:-builddownload_build:docker:*dockerenvironment:*environmentparameters:revision:type:stringsteps:-checkout-setup_node_modules-run:name:Downloadartifactsforrevisioncommand:|gitfetchoriginmaincd./scripts/release&&yarn&&cd../../scripts/release/download-experimental-build.js--commit=<<parameters.revision>>--allowBrokenCI-persist_to_workspace:root:.paths:-builddownload_base_build_for_sizebot:docker:*dockerenvironment:*environmentsteps:-checkout-setup_node_modules-run:name:Downloadartifactsforbaserevisioncommand:|gitfetchoriginmaincd./scripts/release&&yarn&&cd../../scripts/release/download-experimental-build.js--commit=$(gitmerge-baseHEADorigin/main)--allowBrokenCImv./build./base-build-run:#TODO:The`download-experimental-build`scriptcopiesthenpm#packagesintothe`node_modules`directory.Thisisahistorical#quirkofhowthereleasescriptworks.Let'spretendthey#don'texist.name:Deleteextraneousfilescommand:rm-rf./base-build/node_modules-persist_to_workspace:root:.paths:-base-buildprocess_artifacts_combined:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:echo"<<pipeline.git.revision	>>">>build/COMMIT_SHA#Compressbuilddirectoryintoasingletarballforeasydownload-run:tar-zcvf./build.tgz./build#TODO:Migratescriptstouse`build`directoryinsteadof`build2`-run:cp./build.tgz./build2.tgz-store_artifacts:path:./build2.tgz-store_artifacts:path:./build.tgzsizebot:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:at:.-run:echo"<<pipeline.git.revision	>>">>build/COMMIT_SHA-setup_node_modules-run:command:node./scripts/tasks/dangerbuild_devtools_and_process_artifacts:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:environment:RELEASE_CHANNEL:experimentalcommand:./scripts/circleci/pack_and_store_devtools_artifacts.sh-store_artifacts:path:./build/devtools.tgzrun_devtools_e2e_tests:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:name:Playwrightinstalldepscommand:|npxplaywrightinstallsudonpxplaywrightinstall-deps-run:environment:RELEASE_CHANNEL:experimentalcommand:./scripts/circleci/run_devtools_e2e_tests.jsrun_devtools_tests_for_versions:docker:*dockerenvironment:*environmentparallelism:*TEST_PARALLELISMparameters:version:type:stringsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:./scripts/circleci/download_devtools_regression_build.js<<parameters.version>>--replaceBuild-run:node./scripts/jest/jest-cli.js--build--projectdevtools--release-channel=experimental--reactVersion<<parameters.version>>--cirun_devtools_e2e_tests_for_versions:docker:*dockerenvironment:*environmentparallelism:*TEST_PARALLELISMparameters:version:type:stringsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:name:Playwrightinstalldepscommand:|npxplaywrightinstallsudonpxplaywrightinstall-deps-run:./scripts/circleci/download_devtools_regression_build.js<<parameters.version>>-run:environment:RELEASE_CHANNEL:experimentalcommand:./scripts/circleci/run_devtools_e2e_tests.js<<parameters.version>>-run:name:Cleanupbuildregressionfoldercommand:rm-r./build-regression-store_artifacts:path:./tmp/screenshotsyarn_lint_build:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:yarnlint-buildyarn_check_release_dependencies:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:yarncheck-release-dependenciescheck_error_codes:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:*attach_workspace-setup_node_modules-run:name:Searchbuildartifactsforunminifiederrorscommand:|yarnextract-errorsgitdiff--quiet||(echo"Foundunminifiederrors.Eitherupdatetheerrorcodesmapordisableerrorminificationfortheaffectedbuild,ifappropriate."&&false)check_generated_fizz_runtime:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:*attach_workspace-setup_node_modules-run:name:ConfirmgeneratedinlineFizzruntimeisuptodatecommand:|yarngenerate-inline-fizz-runtimegitdiff--quiet||(echo"TherewasachangetotheFizzruntime.Run`yarngenerate-inline-fizz-runtime`andcheckintheresult."&&false)yarn_test:docker:*dockerenvironment:*environmentparallelism:*TEST_PARALLELISMparameters:args:type:stringsteps:-checkout-setup_node_modules-run:yarntest<<parameters.args>>--ciyarn_test_build:docker:*dockerenvironment:*environmentparallelism:*TEST_PARALLELISMparameters:args:type:stringsteps:-checkout-attach_workspace:at:.-setup_node_modules-run:yarntest--build<<parameters.args>>--ciRELEASE_CHANNEL_stable_yarn_test_dom_fixtures:docker:*dockerenvironment:*environmentsteps:-checkout-attach_workspace:at:.-setup_node_modules-*restore_yarn_cache_fixtures_dom-*yarn_install_fixtures_dom-*yarn_install_fixtures_dom_retry-*save_yarn_cache_fixtures_dom-run:name:RunDOMfixturetestsenvironment:RELEASE_CHANNEL:stableworking_directory:fixtures/domcommand:|yarnpredevyarntest--maxWorkers=2test_fuzz:docker:*dockerenvironment:*environmentsteps:-checkout-setup_node_modules-run:name:Runfuzztestscommand:|FUZZ_TEST_SEED=$RANDOMyarntestfuzz--ciFUZZ_TEST_SEED=$RANDOMyarntest--prodfuzz--cipublish_prerelease:parameters:commit_sha:type:stringrelease_channel:type:stringdist_tag:type:stringdocker:*dockerenvironment:*environmentsteps:-checkout-setup_node_modules-run:name:Runpublishscriptcommand:|gitfetchoriginmaincd./scripts/release&&yarn&&cd../../scripts/release/prepare-release-from-ci.js--skipTests-r<<parameters.release_channel>>--commit=<<parameters.commit_sha>>cp./scripts/release/ci-npmrc~/.npmrcscripts/release/publish.js--ci--tags<<parameters.dist_tag>>workflows:build_and_test:unless:<<pipeline.parameters.prerelease_commit_sha>>jobs:-yarn_flow:filters:branches:ignore:-builds/facebook-www-check_generated_fizz_runtime:filters:branches:ignore:-builds/facebook-www-yarn_lint:filters:branches:ignore:-builds/facebook-www-yarn_test:filters:branches:ignore:-builds/facebook-wwwmatrix:parameters:args:#Intentionallypassingtheseasstringsinsteadofcreatinga#separateparameterperCLIargument,sinceit'seasierto#control/seewhichcombinationswewanttorun.-"-r=stable--env=development"-"-r=stable--env=production"-"-r=experimental--env=development"-"-r=experimental--env=production"-"-r=www-classic--env=development--variant=false"-"-r=www-classic--env=production--variant=false"-"-r=www-classic--env=development--variant=true"-"-r=www-classic--env=production--variant=true"-"-r=www-modern--env=development--variant=false"-"-r=www-modern--env=production--variant=false"-"-r=www-modern--env=development--variant=true"-"-r=www-modern--env=production--variant=true"#TODO:Testmorepersistentconfigurations?-'-r=stable--env=development--persistent'-'-r=experimental--env=development--persistent'-yarn_build:filters:branches:ignore:-builds/facebook-www-scrape_warning_messages:filters:branches:ignore:-builds/facebook-www-process_artifacts_combined:requires:-scrape_warning_messages-yarn_build-yarn_test_build:requires:-yarn_buildmatrix:parameters:args:#Intentionallypassingtheseasstringsinsteadofcreatinga#separateparameterperCLIargument,sinceit'seasierto#control/seewhichcombinationswewanttorun.-"-r=stable--env=development"-"-r=stable--env=production"-"-r=experimental--env=development"-"-r=experimental--env=production"#DevTools-"--project=devtools-r=experimental"#TODO:Updatetestconfigtosupportwwwbuildtests#-"-r=www-classic--env=development--variant=false"#-"-r=www-classic--env=production--variant=false"#-"-r=www-classic--env=development--variant=true"#-"-r=www-classic--env=production--variant=true"#-"-r=www-modern--env=development--variant=false"#-"-r=www-modern--env=production--variant=false"#-"-r=www-modern--env=development--variant=true"#-"-r=www-modern--env=production--variant=true"#TODO:Testmorepersistentconfigurations?-download_base_build_for_sizebot:filters:branches:ignore:-main-builds/facebook-www-sizebot:filters:branches:ignore:-mainrequires:-download_base_build_for_sizebot-yarn_build-yarn_lint_build:requires:-yarn_build-yarn_check_release_dependencies:requires:-yarn_build-check_error_codes:requires:-yarn_build-RELEASE_CHANNEL_stable_yarn_test_dom_fixtures:requires:-yarn_build-build_devtools_and_process_artifacts:requires:-yarn_build-run_devtools_e2e_tests:requires:-build_devtools_and_process_artifactsfuzz_tests:unless:<<pipeline.parameters.prerelease_commit_sha>>triggers:-schedule:#Fuzztestsrunhourlycron:"0****"filters:branches:only:-mainjobs:-test_fuzzdevtools_regression_tests:unless:<<pipeline.parameters.prerelease_commit_sha>>triggers:-schedule:#DevToolsregressiontestsrunonceadaycron:"00***"filters:branches:only:-mainjobs:-download_build:revision:<<pipeline.git.revision>>-build_devtools_and_process_artifacts:requires:-download_build-run_devtools_tests_for_versions:requires:-build_devtools_and_process_artifactsmatrix:parameters:version:-"16.0"-"16.5"#schedulepackage-"16.8"#hooks-"17.0"-"18.0"-run_devtools_e2e_tests_for_versions:requires:-build_devtools_and_process_artifactsmatrix:parameters:version:-"16.0"-"16.5"#schedulepackage-"16.8"#hooks-"17.0"-"18.0"#Usedtopublishaprereleasemanuallyviathecommandlinepublish_preleases:when:<<pipeline.parameters.prerelease_commit_sha>>jobs:-publish_prerelease:name:PublishtoCanarychannelcommit_sha:<<pipeline.parameters.prerelease_commit_sha>>release_channel:stable#Thetagstousewhenpublishingcanaries.Themainoneweshould#alwaysincludeis"canary"butwecanusemultiple(e.g.alpha,#beta,rc).Todeclaremultiple,useacomma-separatedstring,like#this:#dist_tag:"canary,alpha,beta,rc"##TODO:Wecurrentlytagcanarieswith"next"inadditionto"canary"#becausethisusedtobecalledthe"next"channelandsome#downstreamconsumersmightstillexpectthattag.Wecanremovethis#aftersometimehaselapsedandthechangehasbeencommunicated.dist_tag:"canary,next"-publish_prerelease:name:PublishtoExperimentalchannelrequires:#NOTE:Intentionallyrunningthesejobssequentiallybecausenpm#willsometimesfailifyoutrytoconcurrentlypublishtwo#differentversionsofthesamepackage,eveniftheyusedifferent#disttags.-PublishtoCanarychannelcommit_sha:<<pipeline.parameters.prerelease_commit_sha>>release_channel:experimentaldist_tag:experimental#Publishesonacronschedulepublish_preleases_nightly:unless:<<pipeline.parameters.prerelease_commit_sha>>triggers:-schedule:#At10minutespast16:00onMon,Tue,Wed,Thu,andFricron:"1016**1,2,3,4,5"filters:branches:only:-mainjobs:-publish_prerelease:name:PublishtoCanarychannelcommit_sha:<<pipeline.git.revision>>release_channel:stabledist_tag:"canary,next"-publish_prerelease:name:PublishtoExperimentalchannelrequires:#NOTE:Intentionallyrunningthesejobssequentiallybecausenpm#willsometimesfailifyoutrytoconcurrentlypublishtwo#differentversionsofthesamepackage,eveniftheyusedifferent#disttags.-PublishtoCanarychannelcommit_sha:<<pipeline.git.revision>>release_channel:experimentaldist_tag:experimental